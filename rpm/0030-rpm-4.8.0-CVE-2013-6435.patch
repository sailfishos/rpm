Index: rpm-4.9.1.2/lib/fsm.c
===================================================================
--- rpm-4.9.1.2.orig/lib/fsm.c
+++ rpm-4.9.1.2/lib/fsm.c
@@ -783,7 +783,7 @@ static int fsmMapAttrs(FSM_t fsm)
 static int expandRegular(FSM_t fsm)
 {
     const struct stat * st = &fsm->sb;
-    rpm_loff_t left = st->st_size;
+    rpm_loff_t left = rpmfiFSizeIndex(fsmGetFi(fsm), fsm->ix);
     int rc = 0;
 
     rc = fsmNext(fsm, FSM_WOPEN);
@@ -2198,7 +2198,12 @@ if (!(fsm->mapFlags & CPIO_ALL_HARDLINKS
 	fsm->rfd = NULL;
 	break;
     case FSM_WOPEN:
-	fsm->wfd = Fopen(fsm->path, "w.ufdio");
+	/* Create the file with 000 permissions. */
+	{
+	    mode_t old_umask = umask(0777);
+	    fsm->wfd = Fopen(fsm->path, "w.ufdio");
+	    umask(old_umask);
+	}
 	if (fsm->wfd == NULL || Ferror(fsm->wfd)) {
 	    if (fsm->wfd != NULL)	(void) fsmNext(fsm, FSM_WCLOSE);
 	    fsm->wfd = NULL;
